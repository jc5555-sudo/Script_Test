#!/usr/bin/env python3
# Python 3.6 compatible
# Enrich CSV Description using Fusion Compiler man pages
# GLOBAL execution directory aware

import csv
import subprocess
import re
import sys
from pathlib import Path
import html

# ==================================================
# PATH RESOLUTION (GLOBAL TOOL BEHAVIOR)
# ==================================================
BASE_DIR = Path(sys.argv[1]).resolve() if len(sys.argv) > 1 else Path.cwd()
CSV_DIR  = BASE_DIR / "logs_report"
CSV_DIR.mkdir(parents=True, exist_ok=True)

# ==================================================
# MAN PAGE CLEANER
# ==================================================
def clean_man_text(text):
    lines = text.splitlines()
    cleaned = []
    recording = False

    for line in lines:
        line = line.rstrip()

        if line.strip().startswith("fc_shell>"):
            continue
        if line.strip() == "NAME":
            recording = True
        if line.strip().startswith("Version "):
            break
        if recording:
            cleaned.append(line)

    return "\n".join(cleaned).strip()

def run_fc_man(codes):
    tcl = []
    for c in codes:
        tcl.append(f'puts "<<<CODE:{c}>>>"')
        tcl.append(f'man {c}')
        tcl.append('puts "<<<END>>>"')
    tcl.append("exit")

    try:
        output = subprocess.check_output(
            "echo '{}' | fc_shell -no_init -no_local_init".format(
                "\n".join(tcl).replace("'", "'\\''")
            ),
            shell=True,
            stderr=subprocess.STDOUT,
            universal_newlines=True
        )
    except subprocess.CalledProcessError as e:
        print("FC ERROR")
        print(e.output)
        return {}

    man_db = {}
    for code, body in re.findall(r'<<<CODE:(.*?)>>>(.*?)<<<END>>>', output, re.S):
        man_db[code.strip()] = clean_man_text(body)

    return man_db

# ==================================================
# HTML GENERATION
# ==================================================
def write_html(csv_path, fields, rows):
    html_path = csv_path.with_suffix(".html")
    with open(html_path, "w", encoding="utf-8") as f:
        f.write("<html><body><table border='1'>\n<tr>")
        for h in fields:
            f.write(f"<th>{html.escape(h)}</th>")
        f.write("</tr>\n")

        for r in rows:
            f.write("<tr>")
            for h in fields:
                val = r.get(h, "")
                if h == "Description":
                    f.write(f"<td><pre>{html.escape(val)}</pre></td>")
                else:
                    f.write(f"<td>{html.escape(val)}</td>")
            f.write("</tr>\n")
        f.write("</table></body></html>")

# ==================================================
# MAIN
# ==================================================
if not CSV_DIR.is_dir():
    print("ERROR: logs_report not found in", BASE_DIR)
    exit(1)

for csv_path in CSV_DIR.glob("*.csv"):
    with open(csv_path, newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)

