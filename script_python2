#!/usr/bin/env python3
# Python 3.6+
# GLOBAL execution directory aware

import csv
import sys
from pathlib import Path
import html

BASE_DIR = Path(sys.argv[1]).resolve() if len(sys.argv) > 1 else Path.cwd()
CSV_DIR  = BASE_DIR / "logs_report"
CSV_DIR.mkdir(parents=True, exist_ok=True)
KEEP = {"WARNING", "ERROR"}

def infer(desc):
    d = desc.lower()
    if "error" in d or "fail" in d:
        return "High", "Check flow and rerun"
    if "warn" in d:
        return "Low", "Review warning"
    return "Medium", "Refer to documentation"

def write_html(path, fields, rows):
    with open(path, "w") as f:
        f.write("<html><body><table border='1'>\n<tr>")
        for h in fields:
            f.write(f"<th>{h}</th>")
        f.write("</tr>\n")
        for r in rows:
            f.write("<tr>")
            for h in fields:
                f.write(f"<td>{html.escape(r.get(h,''))}</td>")
            f.write("</tr>\n")
        f.write("</table></body></html>")

for csv_path in CSV_DIR.glob("*.csv"):
    if csv_path.name.endswith("_summary.csv"):
        continue

    with open(csv_path) as f:
        reader = csv.DictReader(f)
        fields = reader.fieldnames
        rows = [r for r in reader if r.get("Severity","").upper() in KEEP]

    if not rows:
        continue

    if "User Severity" not in fields:
        fields.append("User Severity")
    if "solution" not in fields:
        fields.append("solution")

    for r in rows:
        sev, sol = infer(r.get("Description",""))
        r["User Severity"] = sev
        r["solution"] = sol

    out = csv_path.with_name(csv_path.stem + "_summary.csv")
    with open(out,"w",newline="") as f:
        w = csv.DictWriter(f, fieldnames=fields)
        w.writeheader()
        w.writerows(rows)

    write_html(out.with_suffix(".html"), fields, rows)

print("DONE: Script 2")

