#!/usr/bin/env python3
# Python 3.6 compatible
# Excel-compatible .xls (HTML-based)
# HARD-CODE placeholders
# GLOBAL execution directory aware

import csv
import sys
from pathlib import Path
import html

BASE_DIR = Path(sys.argv[1]).resolve() if len(sys.argv) > 1 else Path.cwd()
CSV_DIR  = BASE_DIR / "logs_report"
CSV_DIR.mkdir(parents=True, exist_ok=True)

KEEP = {"WARNING", "ERROR"}
USER_SEV = "[fill in severity]"
SOLUTION = "[fill in solution]"

def write_xls(path, fields, rows):
    with open(path, "w", encoding="utf-8") as f:
        f.write("""<html><head><style>
table { border-collapse: collapse; width: 100%; table-layout: fixed; }
th, td { border: 1px solid black; padding: 6px; vertical-align: top; }
th { background: #eee; }
.ERROR { background: #ffd6d6; }
.WARNING { background: #fff6cc; }
</style></head><body><table><tr>
""")
        for h in fields:
            f.write(f"<th>{html.escape(h)}</th>")
        f.write("</tr>\n")

        for r in rows:
            sev = r.get("Severity","").upper()
            f.write(f"<tr class='{sev}'>")
            for h in fields:
                val = r.get(h,"")
                if h == "Description":
                    f.write(f"<td><pre>{html.escape(val)}</pre></td>")
                else:
                    f.write(f"<td>{html.escape(val)}</td>")
            f.write("</tr>\n")

        f.write("</table></body></html>")

if not CSV_DIR.is_dir():
    print("ERROR: logs_report not found in", BASE_DIR)
    exit(1)

for csv_path in CSV_DIR.glob("*.csv"):
    if csv_path.name.endswith("_summary.csv"):
        continue

    with open(csv_path, newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        fields = reader.fieldnames
        if not fields or "Severity" not in fields:
            continue
        rows = [r for r in reader if r.get("Severity","").upper() in KEEP]

    if not rows:
        continue

    if "User Severity" not in fields:
        fields.append("User Severity")
    if "solution" not in fields:
        fields.append("solution")

    for r in rows:
        r["User Severity"] = USER_SEV
        r["solution"] = SOLUTION

    out = csv_path.with_name(csv_path.stem + "_summary.xls")
    write_xls(out, fields, rows)
    print("Generated:", out)

print("DONE: Script 3 (XLS)")

